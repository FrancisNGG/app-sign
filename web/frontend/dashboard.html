<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾åˆ°é¢æ¿ - App Sign v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .stat-label {
            color: #999;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        /* ç½‘ç«™å¡ç‰‡ */
        .sites-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .site-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .site-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .site-card.disabled {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .site-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .site-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .status-failed {
            background: #ffebee;
            color: #c62828;
        }

        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-unknown {
            background: #f5f5f5;
            color: #999;
        }

        .site-info {
            margin-bottom: 15px;
            font-size: 13px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #666;
        }

        .info-label {
            color: #999;
        }

        .info-value {
            color: #333;
            font-weight: 500;
        }

        .cookie-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .cookie-valid {
            background: #e8f5e9;
            color: #388e3c;
        }

        .cookie-expired {
            background: #ffebee;
            color: #c62828;
        }

        .cookie-expiring {
            background: #fff3e0;
            color: #f57c00;
        }

        .site-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-action {
            background: #667eea;
            color: white;
        }

        .btn-action:hover {
            background: #5569d8;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h2 {
            color: #333;
            margin-bottom: 10px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: currentColor;
            margin-left: 4px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
            100% {
                transform: translateY(0);
            }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .sites-container {
                grid-template-columns: 1fr;
            }

            .site-actions {
                grid-template-columns: 1fr;
            }
        }

        /* å¯¼èˆªæ  */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 30px;
        }

        .navbar a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .navbar a:hover {
            text-decoration: underline;
        }

        /* Toasté€šçŸ¥ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .toast.success {
            border-left-color: #4caf50;
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast.info {
            border-left-color: #2196f3;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            color: #333;
            font-size: 14px;
            line-height: 1.4;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
    </style>
</head>
<body>
    <!-- Toasté€šçŸ¥å®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ç¼–è¾‘ç½‘ç«™æ¨¡æ€æ¡† -->
    <div id="editSiteModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); overflow-y: auto;">
        <div style="background-color: white; margin: 10% auto; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; max-height: 80vh;">
            <!-- ç²˜æ€§æ ‡é¢˜æ  -->
            <div style="padding: 30px 30px 20px 30px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; z-index: 10;">
                <h2 style="margin: 0; color: #333;" id="editModalTitle">ç¼–è¾‘ç½‘ç«™</h2>
            </div>
            
            <!-- å¯æ»šåŠ¨çš„å†…å®¹åŒºåŸŸ -->
            <div style="overflow-y: auto; padding: 20px 30px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px;">è‡ªåŠ¨ç­¾åˆ°æ—¶é—´</label>
                    <input type="time" id="editRunTime" style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" required>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px;">éšæœºåç§»ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="editRandomRange" min="0" max="120" style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px;">åˆ«åï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="editAliases" placeholder="ä¾‹ï¼šæ©å±±, right" style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <p style="font-size: 12px; color: #999; margin-top: 5px;">æ·»åŠ ç½‘ç«™çš„åˆ«ç§°ï¼Œä¾¿äºè¯†åˆ«ã€‚å¤šä¸ªåˆ«åç”¨é€—å·åˆ†éš”</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="editEnabled" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: #333; font-weight: 500; font-size: 14px;">å·²å¯ç”¨</span>
                    </label>
                </div>

                <div id="editCredentialSection" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px;">å‡­è¯ä¿¡æ¯: <span id="editCredentialType" style="color: #667eea;"></span></label>
                    <p style="font-size: 12px; color: #999; margin-bottom: 12px;">â“˜ è‡³å°‘é…ç½®ä¸€ç§è®¤è¯æ–¹å¼ã€‚Cookie ç”¨äºæµè§ˆå™¨è®¿é—®ï¼Œè´¦å·å¯†ç ç”¨äºè‡ªåŠ¨ç™»å½•</p>
                    
                    <div id="editCookieSection" style="display: none; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px;">Cookie</label>
                        <textarea id="editCookie" style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-family: 'Courier New', monospace; min-height: 100px; resize: vertical;"></textarea>
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·å¤åˆ¶ Cookie</p>
                        <button type="button" onclick="openFetchCookieForEdit()" style="
                            margin-top: 8px;
                            padding: 6px 14px;
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-size: 12px;
                            font-weight: 500;
                            cursor: pointer;
                        ">
                            ğŸ”‘ é€šè¿‡è´¦å·å¯†ç è·å– Cookie
                        </button>
                    </div>

                    <div id="editAccountSection" style="display: none;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">è´¦å·</label>
                            <input type="text" id="editUsername" style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">å¯†ç </label>
                            <input type="password" id="editPassword" style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                </div>

                <div id="editKeepaliveSection" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 12px;">
                        <input type="checkbox" id="editKeepaliveEnabled" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleKeepaliveFields()">
                        <span style="color: #333; font-weight: 500; font-size: 14px;">å¯ç”¨ä¿æ´»</span>
                    </label>
                    
                    <div id="editKeepaliveFields" style="display: none; margin-left: 26px;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">ä¿æ´»æ–¹å¼</label>
                            <select id="editKeepaliveMethod" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="browser_refresh">æµè§ˆå™¨åˆ·æ–°</option>
                                <option value="api_request">APIè¯·æ±‚</option>
                                <option value="hybrid">æ··åˆæ¨¡å¼</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">ä¿æ´»é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="editKeepaliveInterval" min="1" max="10080" value="1440" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <p style="font-size: 12px; color: #999; margin-top: 5px;">æ¨èï¼š1440åˆ†é’Ÿï¼ˆ1å¤©ï¼‰</p>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                    <label style="font-weight: 500; color: #333; font-size: 14px; display: block; margin-bottom: 12px;">é‡è¯•é…ç½®</label>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="editRetryEnabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: #333; font-weight: 500; font-size: 14px;">å¯ç”¨é‡è¯•</span>
                        </label>
                    </div>

                    <div style="margin-bottom: 10px; margin-left: 26px;">
                        <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">æœ€å¤§é‡è¯•æ¬¡æ•°</label>
                        <input type="number" id="editMaxRetries" min="1" max="10" value="3" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div style="margin-left: 26px;">
                        <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">é‡è¯•å»¶è¿Ÿï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="editRetryDelayMinutes" min="1" max="60" value="1" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
            </div>
            
            <!-- ç²˜æ€§åº•éƒ¨æŒ‰é’® -->
            <div style="padding: 20px 30px 30px 30px; border-top: 1px solid #eee; position: sticky; bottom: 0; background: white; z-index: 10; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="saveEditedSite()" style="padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">ä¿å­˜</button>
                <button onclick="closeEditModal()" style="padding: 12px 20px; background: #f0f0f0; color: #333; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="navbar">
        <h2 style="color: #333;">App Sign v2.0</h2>
        <a id="logoutBtn">ç™»å‡º</a>
    </div>

    <div style="max-width: 1400px; margin: 0 auto;">
        <div class="header">
            <h1>ğŸ“Š ç­¾åˆ°é¢æ¿</h1>
            <div class="header-actions">
                <button class="btn-primary" onclick="window.location.href='/add-site'">+ æ·»åŠ ç½‘ç«™</button>
                <button class="btn-secondary" onclick="window.location.href='/settings'">âš™ï¸ è®¾ç½®</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">æ€»ç½‘ç«™æ•°</div>
                <div class="stat-value" id="totalSites">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å·²å¯ç”¨</div>
                <div class="stat-value" id="enabledSites">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¾…æ‰§è¡Œä»»åŠ¡</div>
                <div class="stat-value" id="pendingTasks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥æˆåŠŸ</div>
                <div class="stat-value" id="successToday">0</div>
            </div>
        </div>

        <!-- ç½‘ç«™åˆ—è¡¨ -->
        <h2 style="margin-bottom: 20px; color: #333;">ç½‘ç«™åˆ—è¡¨</h2>
        <div class="sites-container" id="sitesContainer">
            <div class="site-card" style="text-align: center; padding: 40px;">
                <p>åˆå§‹åŒ–ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            try {
                const authResp = await fetch('/api/auth-status', { credentials: 'include' });
                const authData = await authResp.json();
                if (!authData.authenticated) {
                    window.location.href = '/auth';
                    return;
                }
                await loadSites();
                await loadTaskStatus();
                setInterval(() => {
                    loadSites();
                    loadTaskStatus();
                }, 30000);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¼‚å¸¸:', error);
            }
        });

        // ç™»å‡º
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/auth-logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/auth';
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
            }
        });

        // åŠ è½½ç½‘ç«™åˆ—è¡¨
        async function loadSites() {
            try {
                const response = await fetch('/api/sites', { 
                    credentials: 'include',
                    cache: 'no-store'
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                renderSites(data.sites, data.summary);
            } catch (error) {
                console.error('åŠ è½½ç½‘ç«™åˆ—è¡¨å¤±è´¥:', error);
                const container = document.getElementById('sitesContainer');
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">
                        <p>åŠ è½½ç½‘ç«™åˆ—è¡¨å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ç½‘ç«™å¡ç‰‡
        function renderSites(sites, summary) {
            try {
                const container = document.getElementById('sitesContainer');
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('totalSites').textContent = summary?.total || 0;
                document.getElementById('enabledSites').textContent = summary?.enabled || 0;
                
                if (!sites || sites.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1;">
                            <div class="empty-state">
                                <h2>æš‚æ— ç½‘ç«™</h2>
                                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªç½‘ç«™</p>
                                <button class="btn-primary" style="margin-top: 20px;" onclick="window.location.href='/add-site'">+ æ·»åŠ ç½‘ç«™</button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const htmlContent = sites.map((site, idx) => {
                // è®¡ç®—æœ€åç­¾åˆ°æ—¶é—´ - æ˜¾ç¤ºå¹´æœˆæ—¥æ—¶åˆ†
                let lastSignTime = 'æœªç­¾åˆ°';
                if (site.last_sign_time) {
                    const date = new Date(site.last_sign_time);
                    if (!isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        lastSignTime = `${year}-${month}-${day} ${hours}:${minutes}`;
                    }
                }

                // è®¡ç®—ä¸‹æ¬¡ç­¾åˆ°æ—¶é—´ - æ ¹æ®run_timeå’Œrandom_rangeè‡ªåŠ¨è®¡ç®—
                let nextSignTime = '-';
                if (site.run_time) {
                    try {
                        const [hours, minutes] = site.run_time.split(':').map(Number);
                        const now = new Date();
                        const nextSign = new Date(now);
                        nextSign.setHours(hours, minutes, 0, 0);
                        
                        // å¦‚æœå½“å‰æ—¶é—´å·²ç»è¶…è¿‡ç­¾åˆ°æ—¶é—´ï¼Œåˆ™ä¸‹æ¬¡ç­¾åˆ°æ˜¯æ˜å¤©
                        if (nextSign < now) {
                            nextSign.setDate(nextSign.getDate() + 1);
                        }
                        
                        // æ·»åŠ éšæœºåç§»
                        const randomOffset = site.random_range ? Math.floor(Math.random() * site.random_range) : 0;
                        nextSign.setMinutes(nextSign.getMinutes() + randomOffset);
                        
                        const year = nextSign.getFullYear();
                        const month = String(nextSign.getMonth() + 1).padStart(2, '0');
                        const day = String(nextSign.getDate()).padStart(2, '0');
                        const h = String(nextSign.getHours()).padStart(2, '0');
                        const m = String(nextSign.getMinutes()).padStart(2, '0');
                        nextSignTime = `${year}-${month}-${day} ${h}:${m}`;
                    } catch (e) {
                        console.error('è®¡ç®—ä¸‹æ¬¡ç­¾åˆ°æ—¶é—´å¤±è´¥:', e);
                    }
                }

                const lastSignStatus = site.last_sign_status || 'unknown';
                const statusClass = `status-${lastSignStatus}`;
                // åˆ¤æ–­æ˜¯å¦ä»Šå¤©å·²ç­¾åˆ°
                const isSignedToday = (() => {
                    if (lastSignStatus !== 'success' || !site.last_sign_time) return false;
                    const signDate = new Date(site.last_sign_time);
                    const today = new Date();
                    return signDate.getFullYear() === today.getFullYear() &&
                           signDate.getMonth() === today.getMonth() &&
                           signDate.getDate() === today.getDate();
                })();
                const statusText = isSignedToday ? 'âœ… ä»Šæ—¥å·²ç­¾åˆ°' : ({
                    'success': 'âœ“ æˆåŠŸ',
                    'failed': 'âœ— å¤±è´¥',
                    'pending': 'â³ å¾…åš',
                    'unknown': '-'
                }[lastSignStatus] || '-');

                // è®¡ç®—Cookieæœ‰æ•ˆæœŸå’Œè®¤è¯ç±»å‹æ ‡ç­¾
                const validUntil = site.cookie_status?.valid_until;
                const credentialType = site.credential_type || 'none';
                
                let credentialLabel = '';
                
                // ç”Ÿæˆè®¤è¯æ–¹å¼æ ‡ç­¾
                if (credentialType === 'cookie' && site.cookie_status?.has_cookie) {
                    if (validUntil) {
                        const daysRemaining = calculateDaysRemaining(validUntil);
                        if (daysRemaining > 7) {
                            credentialLabel = `<span style="font-size: 12px; color: #4CAF50; margin-left: 8px;">âœ“ Cookie (${daysRemaining}å¤©)</span>`;
                        } else if (daysRemaining > 0) {
                            credentialLabel = `<span style="font-size: 12px; color: #FFA500; margin-left: 8px;">âš  Cookie (${daysRemaining}å¤©)</span>`;
                        } else {
                            credentialLabel = `<span style="font-size: 12px; color: #f44336; margin-left: 8px;">âœ— Cookieè¿‡æœŸ</span>`;
                        }
                    } else {
                        credentialLabel = `<span style="font-size: 12px; color: #4CAF50; margin-left: 8px;">âœ“ Cookie</span>`;
                    }
                } else if (credentialType === 'account') {
                    credentialLabel = `<span style="font-size: 12px; color: #2196F3; margin-left: 8px;">ğŸ‘¤ è´¦å·å¯†ç </span>`;
                } else if (credentialType === 'none') {
                    credentialLabel = `<span style="font-size: 12px; color: #ff9800; margin-left: 8px;">âš ï¸ éœ€è¦é…ç½®å‡­è¯</span>`;
                }

                return `
                    <div class="site-card ${site.enabled ? '' : 'disabled'}">
                        <div class="site-header">
                            <span class="site-title" style="cursor: pointer; flex: 1;" onclick="openEditSiteModal('${site.aliases}', '${site.aliases}')" title="ç‚¹å‡»ç¼–è¾‘æ­¤ç½‘ç«™">${site.aliases}${credentialLabel}</span>
                            <span class="site-status ${statusClass}">${statusText}</span>
                        </div>

                        <div class="site-info">
                            <div class="info-row">
                                <span class="info-label">æœ€åç­¾åˆ°:</span>
                                <span class="info-value">${lastSignTime}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ä¸‹æ¬¡ç­¾åˆ°:</span>
                                <span class="info-value">${nextSignTime}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ä¿æ´»çŠ¶æ€:</span>
                                <span class="info-value">${(() => {
                                    const ka = site.keepalive || {};
                                    if (!ka.enabled) return 'âœ— å·²ç¦ç”¨';
                                    const pad = n => String(n).padStart(2,'0');
                                    const fmt = iso => {
                                        const d = new Date(iso);
                                        if (isNaN(d)) return iso;
                                        return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ ${pad(d.getHours())}:${pad(d.getMinutes())}`;
                                    };
                                    const s = ka.last_keepalive_status;
                                    const lastStr = ka.last_keepalive_time;
                                    const intervalMin = ka.interval_minutes || 1440;
                                    // çŠ¶æ€æ ‡ç­¾
                                    let statusTag = '';
                                    if (s === 'success') statusTag = '<span style="color:#4CAF50">âœ“ ä¸Šæ¬¡æˆåŠŸ</span>';
                                    else if (s === 'failed') statusTag = '<span style="color:#f44336">âœ— ä¸Šæ¬¡å¤±è´¥</span>';
                                    else statusTag = 'âœ“ å·²å¯ç”¨';
                                    // æ—¶é—´æ®µï¼šlast_keepalive_time + interval_minutes
                                    let timeTag = '';
                                    if (lastStr) {
                                        const nextMs = new Date(lastStr).getTime() + intervalMin * 60000;
                                        timeTag = ` Â· ${fmt(lastStr)} â†’ ä¸‹æ¬¡ ${fmt(new Date(nextMs))}`;
                                    }
                                    // Cookie æœ‰æ•ˆæœŸ
                                    const meta = site.cookie_metadata;
                                    let metaTag = '';
                                    if (meta && meta.valid_until) {
                                        const hoursLeft = (new Date(meta.valid_until) - new Date()) / 3600000;
                                        const attempts = meta.refresh_attempts > 0 ? `ï¼Œå·²é‡è¯• ${meta.refresh_attempts} æ¬¡` : '';
                                        metaTag = hoursLeft > 0
                                            ? `<br><span style="color:#888;font-size:11px">Cookie å‰©ä½™æœ‰æ•ˆæœŸ ${hoursLeft.toFixed(1)}h${attempts}</span>`
                                            : `<br><span style="color:#f44336;font-size:11px">Cookie å·²è¿‡æœŸ${attempts}</span>`;
                                    }
                                    return statusTag + timeTag + metaTag;
                                })()}</span>
                            </div>
                        </div>

                        ${site.last_sign_message ? `
                        <div class="site-result" style="margin-top: 10px; padding: 10px; background-color: ${lastSignStatus === 'success' ? '#f1f8f6' : '#fef5f5'}; border-radius: 4px; border-left: 3px solid ${lastSignStatus === 'success' ? '#4CAF50' : '#f44336'};">
                            <div class="result-message" style="font-size: 13px; color: ${lastSignStatus === 'success' ? '#333' : '#d32f2f'}; white-space: pre-wrap; word-break: break-word;">${site.last_sign_message.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                        </div>` : '<div class="site-result" style="display:none"><div class="result-message"></div></div>'}

                        <div class="site-actions">
                            <button class="btn-small btn-action" onclick="execSign('${site.aliases}')">ç«‹å³ç­¾åˆ°</button>
                            <button class="btn-small btn-danger" onclick="removeSite('${site.aliases}')">ç§»é™¤</button>
                        </div>
                    </div>
                `;
                }).join('');
                
                container.innerHTML = htmlContent;
            } catch (error) {
                console.error('æ¸²æŸ“ç«™ç‚¹å¤±è´¥:', error);
                const container = document.getElementById('sitesContainer');
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: #f44336;"><p>æ¸²æŸ“å¤±è´¥: ${error.message}</p></div>`;
            }
        }

        // åŠ è½½ä»»åŠ¡çŠ¶æ€
        async function loadTaskStatus() {
            try {
                const response = await fetch('/api/sign/status', { 
                    credentials: 'include',
                    cache: 'no-store'  // ç¦ç”¨ç¼“å­˜
                });
                const data = await response.json();
                
                const stats = data.task_statistics || {};
                document.getElementById('pendingTasks').textContent = stats.pending || 0;
                document.getElementById('successToday').textContent = stats.success_today || 0;
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // Toasté€šçŸ¥ç³»ç»Ÿ
        function showToast(message, type = 'info', duration = 3000, id = null) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            if (id) toast.id = id;  // ä¾¿äºåç»­æ›´æ–°

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                loading: 'â³'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'â€¢'}</div>
                <div class="toast-content">${message}</div>
            `;

            // ç§»é™¤åŒIDçš„æ—§é€šçŸ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (id) {
                const oldToast = document.getElementById(id);
                if (oldToast) oldToast.remove();
            }

            container.appendChild(toast);

            // durationä¸º0è¡¨ç¤ºä¸è‡ªåŠ¨æ¶ˆå¤±ï¼Œdurationä¸º-1è¡¨ç¤º5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            let finalDuration = duration;
            if (duration === -1) finalDuration = 5000;  // æ­£åœ¨æ‰§è¡ŒçŠ¶æ€ï¼š5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            
            if (finalDuration > 0) {
                setTimeout(() => {
                    if (toast.parentNode) {  // åªæœ‰è¿˜åœ¨DOMä¸­æ‰ç§»é™¤
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateX(400px)';
                        toast.style.transition = 'all 0.3s ease';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, finalDuration);
            }

            return toast;
        }

        // ç«‹å³ç­¾åˆ°
        async function execSign(siteName) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'â³ ç­¾åˆ°ä¸­...';

            const toastId = `sign-${siteName}`;
            showToast(`æ­£åœ¨ä¸º ${siteName} æ‰§è¡Œç­¾åˆ°ä»»åŠ¡...`, 'info', -1, toastId);

            try {
                const response = await fetch(`/api/sign/${siteName}/execute`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (response.ok) {
                    // æˆåŠŸå¯åŠ¨ï¼Œç°åœ¨è½®è¯¢æŸ¥è¯¢ç»“æœ
                    let retryCount = 0;
                    const maxRetries = 10;  // è½®è¯¢10æ¬¡ï¼Œæœ€å¤š20ç§’
                    let foundResult = false;

                    const pollResult = setInterval(async () => {
                        retryCount++;
                        
                        try {
                            const statusResp = await fetch(`/api/sign/${siteName}/status`, {
                                credentials: 'include'
                            });
                            const statusData = await statusResp.json();

                            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç»“æœ
                            if (statusData.status === 'success' && statusData.data) {
                                const result = statusData.data;
                                foundResult = true;
                                clearInterval(pollResult);

                                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                                if (result.status === 'success') {
                                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ŒåŒ…å«è¯¦ç»†ä¿¡æ¯
                                    const msgLines = result.message ? result.message.split('\n') : [];
                                    const shortMsg = msgLines[0] || `âœ… ${siteName} ç­¾åˆ°æˆåŠŸ`;
                                    showToast(shortMsg, 'success', 5000, toastId);
                                } else {
                                    // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                                    let errorMsg = result.message || 'ç­¾åˆ°å¤±è´¥';
                                    
                                    // æ ¹æ®é”™è¯¯ç±»å‹ç»™å‡ºæ›´å‹å¥½çš„æç¤º
                                    if (result.error_type === 'cookie_expired') {
                                        errorMsg = 'âŒ Cookieå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•';
                                    } else if (result.error_type === 'network_error') {
                                        errorMsg = 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                                    } else if (result.error_type === 'login_failed') {
                                        errorMsg = 'âŒ ç™»å½•ä¿¡æ¯æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•';
                                    } else {
                                        errorMsg = `âŒ ç­¾åˆ°å¤±è´¥ï¼š${errorMsg}`;
                                    }
                                    
                                    showToast(errorMsg, 'error', 7000, toastId);
                                }

                                // ç­¾åˆ°å®Œæˆåç«‹åˆ»åˆ·æ–°å¡ç‰‡ï¼ˆä»æœåŠ¡ç«¯å–æœ€æ–°æ•°æ®ï¼Œå« last_sign_messageï¼‰
                                await loadSites();
                            }
                        } catch (err) {
                            console.error('æŸ¥è¯¢ç­¾åˆ°çŠ¶æ€å¤±è´¥:', err);
                        }

                        // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢è½®è¯¢
                        if (retryCount >= maxRetries && !foundResult) {
                            clearInterval(pollResult);
                            showToast(`â³ ç­¾åˆ°ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨å€™ç¡®è®¤ç»“æœ`, 'info', 5000, toastId);
                        }
                    }, 2000);

                    // æ›´æ–°å¡ç‰‡æ˜¾ç¤ºçŠ¶æ€ä¸º"æ­£åœ¨ç­¾åˆ°"
                    const card = btn.closest('.site-card');
                    if (card) {
                        const statusDiv = card.querySelector('.site-status');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<span class="pulse">â³ ç­¾åˆ°ä¸­...</span>';
                            statusDiv.className = 'site-status status-pending';
                        }
                    }
                } else {
                    showToast(`âŒ ç­¾åˆ°å¤±è´¥: ${data.message}`, 'error', 5000, toastId);
                }
            } catch (error) {
                console.error('ç­¾åˆ°å¤±è´¥:', error);
                showToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œç­¾åˆ°å¯åŠ¨å¤±è´¥', 'error', 5000, toastId);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ç§»é™¤ç½‘ç«™
        async function removeSite(siteName) {
            if (!confirm(`ç¡®å®šè¦ç§»é™¤ "${siteName}" å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼`)) {
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'åˆ é™¤ä¸­...';

            try {
                const response = await fetch(`/api/sites/${encodeURIComponent(siteName)}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showToast(`âœ“ å·²æˆåŠŸåˆ é™¤ "${siteName}"`, 'success');
                    // 2ç§’ååˆ·æ–°åˆ—è¡¨
                    setTimeout(() => {
                        loadSites();
                    }, 1000);
                } else {
                    showToast(`âœ— åˆ é™¤å¤±è´¥: ${data.message}`, 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('åˆ é™¤ç½‘ç«™å¤±è´¥:', error);
                showToast(`âœ— ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }


        // æ‰“å¼€ç¼–è¾‘ç½‘ç«™æ¨¡æ€æ¡†
        async function openEditSiteModal(siteName, aliases = '') {
            const modal = document.getElementById('editSiteModal');
            modal.dataset.siteName = siteName;  // ä¿å­˜siteNameä¾›saveEditedSiteä½¿ç”¨
            document.getElementById('editModalTitle').textContent = `ç¼–è¾‘ - ${aliases || siteName}`;
            
            // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
            document.getElementById('editRunTime').value = '09:00';
            document.getElementById('editRandomRange').value = 0;
            document.getElementById('editAliases').value = aliases || '';
            document.getElementById('editEnabled').checked = true;
            document.getElementById('editRetryEnabled').checked = true;
            document.getElementById('editMaxRetries').value = 3;
            document.getElementById('editRetryDelayMinutes').value = 1;
            document.getElementById('editKeepaliveEnabled').checked = true;
            document.getElementById('editKeepaliveMethod').value = 'browser_refresh';
            document.getElementById('editKeepaliveInterval').value = 1440;
            
            // æ¸…ç©ºè®¤è¯å­—æ®µ
            document.getElementById('editCookie').value = '';
            document.getElementById('editUsername').value = '';
            document.getElementById('editPassword').value = '';
            
            // ä»APIè·å–å®Œæ•´çš„ç½‘ç«™ä¿¡æ¯
            try {
                const response = await fetch(`/api/sites/${encodeURIComponent(siteName)}`, { credentials: 'include' });
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½ç½‘ç«™ä¿¡æ¯');
                
                const data = await response.json();
                if (data.status === 'success' && data.site) {
                    const site = data.site;
                    
                    // æ ¹æ®å®é™…å­˜åœ¨çš„å­—æ®µå†³å®šæ˜¾ç¤ºä»€ä¹ˆï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
                    const hasCookie = site && site.cookie && site.cookie.trim().length > 0;
                    const hasUsername = site && site.username && site.username.trim().length > 0;
                    
                    // æ›´æ–°è¡¨å•æ•°æ®
                    if (site.run_time) {
                        document.getElementById('editRunTime').value = site.run_time.substring(0, 5);
                    }
                    if (site.random_range !== undefined) {
                        document.getElementById('editRandomRange').value = site.random_range;
                    }
                    
                    // è·å–æˆ–è®¾ç½®åˆ«å
                    if (site.aliases) {
                        document.getElementById('editAliases').value = site.aliases;
                    }
                    // ä¿å­˜æ¨¡å—ä¿¡æ¯ï¼Œä¾›è·å–Cookieå¼¹çª—ä½¿ç”¨
                    modal.dataset.siteModule = site.module || '';
                    
                    // æ›´æ–°å¯ç”¨çŠ¶æ€
                    if (site.enabled !== undefined) {
                        document.getElementById('editEnabled').checked = site.enabled;
                    }
                    
                    // å¡«å……é‡è¯•é…ç½®
                    if (site.retry) {
                        document.getElementById('editRetryEnabled').checked = site.retry.enabled !== false;
                        document.getElementById('editMaxRetries').value = site.retry.max_retries || 3;
                        document.getElementById('editRetryDelayMinutes').value = site.retry.retry_delay_minutes || 1;
                    }
                    
                    // å¡«å……è®¤è¯ä¿¡æ¯ï¼ˆä»…å¡«å……å®é™…å­˜åœ¨çš„å­—æ®µï¼‰
                    if (site.cookie) {
                        document.getElementById('editCookie').value = site.cookie;
                    }
                    if (site.username) {
                        document.getElementById('editUsername').value = site.username;
                    }
                    if (site.password) {
                        document.getElementById('editPassword').value = site.password;
                    }
                    
                    // æ ¹æ®å®é™…æ•°æ®å†³å®šæ˜¾ç¤ºå“ªäº›è®¤è¯å­—æ®µï¼ˆå†³å®šæ€§çš„é€»è¾‘ï¼‰
                    const cookieSection = document.getElementById('editCookieSection');
                    const accountSection = document.getElementById('editAccountSection');
                    
                    if (hasCookie && !hasUsername) {
                        // ä»…æœ‰Cookieï¼šåªæ˜¾ç¤ºCookieå­—æ®µï¼ˆç¦æ­¢ç¼–è¾‘è´¦å·å¯†ç ï¼‰
                        cookieSection.style.display = 'block';
                        accountSection.style.display = 'none';
                        document.getElementById('editCredentialType').innerHTML = '<span style="color: #4CAF50;">ğŸ” Cookie</span>';
                    }
                    else if (hasUsername && !hasCookie) {
                        // ä»…æœ‰è´¦å·å¯†ç ï¼šåªæ˜¾ç¤ºè´¦å·å¯†ç å­—æ®µï¼ˆç¦æ­¢ç¼–è¾‘Cookieï¼‰
                        cookieSection.style.display = 'none';
                        accountSection.style.display = 'block';
                        document.getElementById('editCredentialType').innerHTML = '<span style="color: #2196F3;">ğŸ‘¤ è´¦å·å¯†ç </span>';
                    }
                    else if (!hasCookie && !hasUsername) {
                        // éƒ½æ²¡æœ‰ï¼šæ˜¾ç¤ºä¸¤ä¸ªå­—æ®µï¼Œè®©ç”¨æˆ·é€‰æ‹©å…¶ä¸­ä¸€ä¸ª
                        cookieSection.style.display = 'block';
                        accountSection.style.display = 'block';
                        document.getElementById('editCredentialType').innerHTML = '<span style="color: #FF9800;">âš ï¸ æœªé…ç½® - è¯·é€‰æ‹©å…¶ä¸­ä¸€ç§</span>';
                    }
                    else {
                        // ä¸¤ä¸ªéƒ½æœ‰ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä¸ºäº†å…¼å®¹æ€§ï¼‰ï¼šéƒ½æ˜¾ç¤º
                        cookieSection.style.display = 'block';
                        accountSection.style.display = 'block';
                        document.getElementById('editCredentialType').innerHTML = '<span style="color: #9C27B0;">ğŸ”“ å·²é…ç½®ä¸¤ç§æ–¹å¼</span>';
                    }
                    
                    // å¡«å……ä¿æ´»é…ç½®
                    if (site.keepalive) {
                        document.getElementById('editKeepaliveEnabled').checked = site.keepalive.enabled !== false;
                        document.getElementById('editKeepaliveMethod').value = site.keepalive.method || 'browser_refresh';
                        if (site.keepalive.interval_minutes) {
                            document.getElementById('editKeepaliveInterval').value = site.keepalive.interval_minutes;
                        } else if (site.keepalive.interval_days) {
                            document.getElementById('editKeepaliveInterval').value = site.keepalive.interval_days * 1440;
                        }
                        // æ›´æ–°keepaliveå­—æ®µçš„æ˜¾ç¤ºçŠ¶æ€
                        toggleKeepaliveFields();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç½‘ç«™ä¿¡æ¯å¤±è´¥:', error);
                // é™çº§å¤„ç†ï¼šè‡³å°‘æ˜¾ç¤ºCookieå­—æ®µ
                document.getElementById('editCookieSection').style.display = 'block';
                document.getElementById('editAccountSection').style.display = 'block';
                showToast('âš ï¸ æ— æ³•åŠ è½½å®Œæ•´çš„ç½‘ç«™ä¿¡æ¯ï¼Œè¯·è°¨æ…ç¼–è¾‘', 'info', 3000);
            }
            
            // ä¿å­˜å½“å‰ç¼–è¾‘çš„ç½‘ç«™åç§°
            modal.dataset.siteName = siteName;
            modal.style.display = 'block';
        }

        // åˆ‡æ¢ä¿æ´»å­—æ®µæ˜¾ç¤º
        function toggleKeepaliveFields() {
            const enabled = document.getElementById('editKeepaliveEnabled').checked;
            const fieldsDiv = document.getElementById('editKeepaliveFields');
            fieldsDiv.style.display = enabled ? 'block' : 'none';
        }

        // ESC é”®å…³é—­ç¼–è¾‘å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('editSiteModal');
                if (modal && modal.style.display !== 'none') closeEditModal();
            }
        });

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editSiteModal').style.display = 'none';
        }

        // ä¿å­˜ç¼–è¾‘çš„ç½‘ç«™
        async function saveEditedSite() {
            const modal = document.getElementById('editSiteModal');
            const siteName = modal.dataset.siteName;
            
            if (!siteName) {
                alert('é”™è¯¯ï¼šæœªæŒ‡å®šç½‘ç«™');
                return;
            }
            
            const runTime = document.getElementById('editRunTime').value;
            const randomRange = parseInt(document.getElementById('editRandomRange').value) || 0;
            const aliases = document.getElementById('editAliases').value.trim();
            const enabled = document.getElementById('editEnabled').checked;
            
            if (!runTime) {
                alert('è¯·è®¾ç½®ç­¾åˆ°æ—¶é—´');
                return;
            }
            
            if (!aliases) {
                alert('è¯·è®¾ç½®å¡ç‰‡æ ‡ç­¾åç§°');
                return;
            }
            
            try {
                const payload = {
                    name: siteName,
                    aliases: aliases,
                    run_time: runTime + ':00',
                    random_range: randomRange,
                    enabled: enabled
                };
                
                // æ·»åŠ è®¤è¯ä¿¡æ¯ - æ ¹æ®å­—æ®µçš„æ˜¾ç¤º/éšè—çŠ¶æ€æ¥å†³å®š
                const cookieSection = document.getElementById('editCookieSection');
                const accountSection = document.getElementById('editAccountSection');
                
                // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºï¼ˆæ ¹æ®displayå±æ€§ï¼‰
                const cookieIsVisible = cookieSection && cookieSection.style.display !== 'none';
                const accountIsVisible = accountSection && accountSection.style.display !== 'none';
                
                const cookieInput = document.getElementById('editCookie');
                const usernameInput = document.getElementById('editUsername');
                const passwordInput = document.getElementById('editPassword');
                
                if (cookieIsVisible) {
                    // Cookieå­—æ®µæ˜¾ç¤ºï¼šå‘é€å½“å‰å€¼
                    payload.cookie = cookieInput.value.trim();
                    // å¦‚æœè´¦å·å¯†ç å­—æ®µéšè—ï¼Œæ¸…ç©ºå®ƒä»¬
                    if (!accountIsVisible) {
                        payload.username = '';
                        payload.password = '';
                    }
                }
                
                if (accountIsVisible) {
                    // è´¦å·å¯†ç å­—æ®µæ˜¾ç¤ºï¼šå‘é€å½“å‰å€¼
                    payload.username = usernameInput.value.trim();
                    payload.password = passwordInput.value.trim();
                    // å¦‚æœCookieå­—æ®µéšè—ï¼Œæ¸…ç©ºå®ƒ
                    if (!cookieIsVisible) {
                        payload.cookie = '';
                    }
                }
                
                // æ·»åŠ é‡è¯•é…ç½®
                const retryEnabledInput = document.getElementById('editRetryEnabled');
                const maxRetriesInput = document.getElementById('editMaxRetries');
                const retryDelayInput = document.getElementById('editRetryDelayMinutes');
                if (retryEnabledInput) {
                    payload.retry = {
                        enabled: retryEnabledInput.checked,
                        max_retries: parseInt(maxRetriesInput.value) || 3,
                        retry_delay_minutes: parseInt(retryDelayInput.value) || 1
                    };
                }
                
                // æ·»åŠ ä¿æ´»é…ç½®
                const keepaliveEnabledInput = document.getElementById('editKeepaliveEnabled');
                const keepaliveMethodInput = document.getElementById('editKeepaliveMethod');
                const keepaliveIntervalInput = document.getElementById('editKeepaliveInterval');
                if (keepaliveEnabledInput) {
                    payload.keepalive = {
                        enabled: keepaliveEnabledInput.checked,
                        method: keepaliveMethodInput ? keepaliveMethodInput.value : 'browser_refresh',
                        interval_minutes: parseInt(keepaliveIntervalInput.value) || 1440
                    };
                }
                
                const response = await fetch('/api/sites/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast(`âœ“ ${aliases || siteName} å·²æ›´æ–°`, 'success', 3000);
                    closeEditModal();
                    await loadSites();  // é‡æ–°åŠ è½½ç«™ç‚¹åˆ—è¡¨
                } else {
                    showToast(`âœ— æ›´æ–°å¤±è´¥: ${data.message}`, 'error', 5000);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showToast(`âœ— é”™è¯¯: ${error.message}`, 'error', 5000);
            }
        }

        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            try {
                const date = new Date(timeStr);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
                
                return date.toLocaleDateString('zh-CN');
            } catch {
                return timeStr;
            }
        }

        // å·¥å…·å‡½æ•°ï¼šè®¡ç®—å‰©ä½™å¤©æ•°
        function calculateDaysRemaining(dateStr) {
            try {
                const date = new Date(dateStr);
                const now = new Date();
                const diff = date - now;
                return Math.ceil(diff / (1000 * 60 * 60 * 24));
            } catch {
                return 0;
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–å…³é—­
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('editSiteModal');
            if (event.target === modal) {
                closeEditModal();
            }
        });

        // ---- ç¼–è¾‘å¼¹çª—ä¸­é€šè¿‡è´¦å·å¯†ç è·å– Cookie ----
        let _editFetchCookieHandler = null;
        function openFetchCookieForEdit() {
            const modal = document.getElementById('editSiteModal');
            const module = modal.dataset.siteModule || '';
            if (!module) {
                showToast('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªç«™ç‚¹è¿›è¡Œç¼–è¾‘', 'error', 3000);
                return;
            }
            const url = `/fetch-cookie?module=${encodeURIComponent(module)}&targetId=editSiteCookie`;
            const popup = window.open(url, 'fetchCookieEdit',
                'width=1060,height=800,resizable=yes,scrollbars=no');
            if (!popup) {
                showToast('å¼¹çª—è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œè¯·å…è®¸å¼¹å‡ºçª—å£åé‡è¯•', 'error', 4000);
                return;
            }
            if (_editFetchCookieHandler) window.removeEventListener('message', _editFetchCookieHandler);
            _editFetchCookieHandler = function(e) {
                if (!e.data || e.data.type !== 'fetchedCookie') return;
                if (e.data.targetId && e.data.targetId !== 'editSiteCookie') return;
                const ta = document.getElementById('editCookie');
                if (ta) ta.value = e.data.cookie || '';
                showToast('âœ… Cookie å·²è‡ªåŠ¨å¡«å……ï¼Œè¯·æ ¸å¯¹åä¿å­˜', 'success', 4000);
                window.removeEventListener('message', _editFetchCookieHandler);
                _editFetchCookieHandler = null;
            };
            window.addEventListener('message', _editFetchCookieHandler);
        }
    </script>

</body>
</html>
